# チケット034: 請求書明細機能強化

## 概要
請求書明細の入力を効率化する機能を実装。商品マスタからの選択、直接入力、明細の並び替え、複製などの機能を追加。

## 要件

### 機能要件
1. **商品マスタ連携**
   - 商品選択ドロップダウン/モーダル
   - 選択時に以下を自動入力：
     - 品目名
     - 単価
     - 単位
   - 数量は手動入力
   - 金額自動計算

2. **直接入力モード**
   - 商品マスタを使わない直接入力
   - すべての項目を手動入力
   - 金額は自動計算

3. **明細操作機能**
   - 行の追加（最大10行）
   - 行の削除
   - 行の複製
   - 行の並び替え（ドラッグ&ドロップ）
   - 一括クリア

4. **計算機能**
   - 行ごとの金額計算（数量 × 単価）
   - 小計の自動計算
   - 消費税計算（10%、端数切り捨て）
   - 合計金額の表示

5. **バリデーション**
   - 数量：正の数値
   - 単価：0以上の数値
   - 品目名：必須
   - 最大10行制限

### データ構造
```sql
invoice_items (拡張)
- product_id (UUID, Nullable, FK) -- 商品マスタ選択時
- item_name (String, NOT NULL)
- quantity (Decimal, NOT NULL)
- unit (String, NOT NULL)
- unit_price (Decimal, NOT NULL)
- amount (Decimal, NOT NULL)
- description (Text, Nullable)
- display_order (Integer, NOT NULL)
```

## タスク

### バックエンド実装
- [x] 商品マスタ検索API
- [x] 明細保存処理の改善
- [x] 並び順保存処理
- [x] バリデーション強化

### フロントエンド実装
- [x] 商品選択コンポーネント
- [x] 明細入力テーブルコンポーネント
- [x] ドラッグ&ドロップ機能
- [x] 複製・削除ボタン
- [x] 自動計算処理

### UI/UX改善
- [x] リアルタイム計算表示
- [ ] 入力補助（Tab移動など）
- [ ] エラー表示の改善
- [ ] モバイル対応

### テスト
- [x] 商品選択からの明細追加
- [x] 直接入力での明細追加
- [x] 並び替え機能
- [x] 計算精度の確認
- [x] 最大行数制限の確認

## 成功基準
- [x] 商品マスタから選択して明細を追加できる
- [x] 直接入力でも明細を追加できる
- [x] ドラッグ&ドロップで並び替えができる
- [x] 金額計算が正確に行われる
- [x] 10行を超える追加が制限される

## 注意事項
- 消費税は10%固定、端数切り捨て
- 商品マスタ削除後も明細は保持される
- 並び順はdisplay_orderで管理
- 小数点以下の扱いに注意（金額は整数）

## 依存関係
- 商品マスタ機能（031で実装）
- 請求書作成・編集画面