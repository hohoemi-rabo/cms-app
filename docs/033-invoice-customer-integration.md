# チケット033: 請求書-顧客連携機能

## 概要
請求書作成・編集時に既存顧客データと連携する機能を実装。顧客選択により請求先情報を自動入力し、効率的な請求書作成を実現する。

## 要件

### 機能要件
1. **顧客選択機能**
   - 請求書作成/編集画面での顧客選択
   - ドロップダウンまたはモーダル選択
   - 顧客検索機能（名前、会社名）
   - 選択後、請求先情報を自動入力

2. **直接入力モード**
   - 顧客を選択せずに請求先を直接入力
   - 入力フィールド：
     - 請求先名（必須）
     - 住所（任意）
     - 敬称（様/御中）選択

3. **切り替え機能**
   - 顧客選択と直接入力の切り替え
   - トグルボタンまたはラジオボタン
   - 切り替え時のデータ保持確認

4. **データ保存**
   - 顧客選択時：customer_idを保存
   - 直接入力時：入力内容をスナップショット保存
   - 両方の場合で請求先情報を保持

### 請求書テーブル拡張
```sql
invoices (拡張)
- customer_id (UUID, Nullable, FK) -- 顧客選択時
- billing_name (String, NOT NULL) -- 請求先名
- billing_address (String, Nullable) -- 請求先住所
- billing_honorific (String, DEFAULT '様') -- 敬称
- customer_snapshot (JSONB, Nullable) -- 顧客情報スナップショット
```

### API設計
- `GET /api/customers/search` - 顧客検索
- `GET /api/customers/[id]` - 顧客詳細取得
- 既存の請求書APIを拡張

## タスク

### データベース設定
- [x] invoicesテーブルにカラム追加
- [x] 外部キー制約の設定
- [x] インデックスの追加

### バックエンド実装
- [x] 顧客検索API
- [x] 請求書作成/更新APIの拡張
- [x] スナップショット保存処理
- [x] バリデーション処理

### フロントエンド実装
- [x] 顧客選択コンポーネント
- [x] 直接入力フォームコンポーネント
- [x] 切り替えUIコンポーネント
- [x] 請求書作成画面の改修
- [x] 請求書編集画面の改修

### 連携処理
- [x] 顧客選択時の自動入力
- [x] 敬称の自動判定（個人/法人）
- [x] データ切り替え時の処理

### テスト
- [x] 顧客選択からの請求書作成
- [x] 直接入力からの請求書作成
- [x] 切り替え動作のテスト
- [x] 顧客削除後の請求書表示

## 成功基準
- [x] 顧客選択により請求先が自動入力される
- [x] 直接入力でも請求書が作成できる
- [x] 顧客削除後も請求書の請求先情報が保持される
- [x] 切り替え時に適切な警告が表示される
- [x] 検索機能が正常に動作する

## 注意事項
- 顧客削除時も請求書は影響を受けない（スナップショット）
- 敬称は「様」「御中」から選択
- 個人顧客は「様」、法人は「御中」をデフォルトに

## 依存関係
- 既存の顧客管理機能
- 請求書作成・編集画面（030で実装済み）