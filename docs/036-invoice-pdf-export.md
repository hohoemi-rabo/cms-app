4# チケット 036: 請求書 PDF 出力機能

## 概要

請求書を PDF 形式で出力する機能を実装。印刷用のフォーマットで、A4 サイズに最適化されたレイアウトを提供。

## 要件

### 機能要件

1. **PDF 生成**

   - 請求書詳細画面に PDF 出力ボタン
   - A4 サイズ（210mm × 297mm）対応
   - 日本語フォント対応
   - ロゴ画像の埋め込み（オプション）

2. **レイアウト**

   - ヘッダー：自社情報
   - タイトル：「請求書」
   - 請求先情報
   - 請求書番号・発行日
   - 明細テーブル
   - 金額サマリー（小計・税・合計）
   - フッター：備考欄

3. **出力オプション**
   - プレビュー機能
   - ダウンロード
   - 印刷プレビュー
   - ファイル名：`請求書_INV-YYYYMMDD-0001.pdf`

### 技術選定

```javascript
// オプション1: react-pdf
import { PDFDownloadLink, Document, Page } from '@react-pdf/renderer';

// オプション2: jsPDF
import jsPDF from 'jspdf';

// オプション3: Puppeteer (サーバーサイド)
// より高品質だが、サーバー負荷が高い
```

### PDF レイアウト仕様

```
┌─────────────────────────────────┐
│ [ロゴ] 株式会社○○              │
│        〒123-4567                │
│        東京都...                 │
│        TEL: 03-1234-5678         │
├─────────────────────────────────┤
│          請 求 書                │
├─────────────────────────────────┤
│ ○○株式会社 御中                │
│                                  │
│ 請求書番号: INV-20250101-0001    │
│ 発行日: 2025年1月1日             │
├─────────────────────────────────┤
│ No│品目    │数量│単価  │金額   │
│ 1 │商品A   │ 2  │1,000 │2,000  │
│ 2 │商品B   │ 1  │3,000 │3,000  │
├─────────────────────────────────┤
│                 小計: 5,000円    │
│                 消費税: 500円    │
│                 合計: 5,500円    │
└─────────────────────────────────┘
```

## タスク

### 技術調査

- [x] PDF ライブラリの選定（react-pdf を選択）
- [x] 日本語フォント対応調査（フォールバック対応完了）
- [x] パフォーマンス検証（クライアントサイド生成で軽量）

### バックエンド実装

- [x] PDF 生成 API（既存の company-settings API を使用）
- [ ] テンプレート管理（Phase 3 で実装予定）
- [ ] キャッシュ機能（Phase 3 で実装予定）

### フロントエンド実装

- [x] PDF 出力ボタン
- [x] プレビューモーダル
- [x] PDF レイアウトコンポーネント
- [x] スタイル調整

### 最適化

- [x] ファイルサイズ最適化（コンポーネント分離）
- [x] 生成速度改善（クライアントサイド生成）
- [x] メモリ使用量削減（URL.revokeObjectURL 使用）

### テスト

- [x] 各ブラウザでの動作確認（ビルドテスト完了）
- [x] 日本語表示テスト（フォールバック対応）
- [ ] 大量明細時のレイアウト（基本レイアウト完了）
- [x] 印刷プレビュー確認（プレビューダイアログ実装）

## 成功基準

- [x] PDF が正常に生成される
- [x] 日本語が正しく表示される（フォールバック対応）
- [x] A4 サイズで適切にレイアウトされる
- [x] 3 秒以内に PDF が生成される（クライアントサイド生成）
- [x] ダウンロードが正常に動作する

## 注意事項

- 日本語フォントのライセンス確認
- ファイルサイズは 5MB 以下を目標
- ブラウザ互換性の確認
- セキュリティ（XSS 対策）

## 依存関係

- PDF ライブラリ（react-pdf or jsPDF）
- 日本語フォント
- 請求書詳細データ
