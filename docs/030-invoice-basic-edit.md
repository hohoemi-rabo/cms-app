# 030 - 請求書編集機能（基本版）

## 概要

請求書の基本的な編集機能を実装。
**骨組み重視**: 作成機能と同じ項目での編集、削除機能も含む。

## 対象範囲

### 画面仕様
- URL: `/invoices/[id]/edit`
- 作成画面と同じフォーム
- 既存データの読み込み
- 更新・削除機能

### 編集項目
- 作成機能と同じ項目すべて
- 請求書番号は編集不可
- 発行日、請求先名、明細すべて編集可能

## Tasks

- [x] `/src/app/invoices/[id]/edit/page.tsx` 作成
- [x] 請求書更新API作成 (`PUT /api/invoices/[id]`)
- [x] 請求書削除API作成 (`DELETE /api/invoices/[id]`)
- [x] 既存データ取得・フォーム初期化
- [x] 更新処理実装
- [x] 削除確認ダイアログ実装
- [x] 削除処理実装（論理削除）
- [x] 404エラー対応（存在しない請求書ID）
- [x] 更新成功時の詳細画面への遷移

## UI設計方針

### レイアウト
```
┌─────────────────────────────────┐
│ [戻る] 請求書編集    [削除]     │
├─────────────────────────────────┤
│ 請求書番号: INV-001 (編集不可)   │
│ 発行日: [2024-12-09]            │
│ 請求先: [既存データ表示]         │
├─────────────────────────────────┤
│ 明細（既存データが表示される）    │
│ ┌─────┬─────┬─────┬─────────┐ │
│ │品目  │数量  │単価  │金額     │ │
│ │[既存]│[既存]│[既存]│[自動計算]│ │
│ └─────┴─────┴─────┴─────────┘ │
├─────────────────────────────────┤
│                    合計: [計算]円│
│ [キャンセル] [更新]             │
└─────────────────────────────────┘
```

### 削除確認ダイアログ
```
┌─────────────────────┐
│ 請求書を削除しますか？ │
│                    │
│ この操作は取り消せません │
│                    │
│ [キャンセル] [削除]  │
└─────────────────────┘
```

## 機能仕様

### データ取得と初期化
```typescript
// 編集画面用のデータ取得
const getInvoiceForEdit = async (id: string) => {
  const invoice = await fetchInvoiceById(id)
  const items = await fetchInvoiceItems(id)
  return { invoice, items }
}

// フォーム初期値設定
const initializeForm = (invoice, items) => {
  setFormData({
    issueDate: invoice.issue_date,
    billingName: invoice.billing_name,
    items: items.map(item => ({
      itemName: item.item_name,
      quantity: item.quantity,
      unitPrice: item.unit_price
    }))
  })
}
```

### 更新処理
- PUT /api/invoices/[id] で請求書基本情報更新
- 明細は全削除→再作成で対応（シンプルな実装）
- updated_at を現在時刻で更新

### 削除処理
- 論理削除（deleted_at に削除日時設定）
- 明細も同時に論理削除
- 削除後は一覧画面にリダイレクト

## 注意事項

1. **機能を絞る**:
   - 編集履歴機能は後で追加
   - 部分更新は後で最適化
   - 同時編集制御は後で追加

2. **エラーハンドリング**:
   - 存在しない請求書IDの場合は404
   - 削除済み請求書の編集は禁止
   - 更新中のエラー表示

3. **UX考慮**:
   - 削除時の確認ダイアログは必須
   - キャンセル時は詳細画面に戻る
   - 更新成功時の通知表示

## 成功基準

- [x] 既存データがフォームに正しく表示される
- [x] 各項目が編集できる
- [x] 請求書番号は編集不可になっている
- [x] 更新処理が正常に動作する
- [x] 削除確認ダイアログが表示される
- [x] 削除処理が正常に動作する（論理削除）
- [x] 存在しない請求書で404エラーが表示される
- [x] 更新・削除後に適切な画面に遷移する